<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart Test - RiskMatrix</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
    <h1>Chart Test Page</h1>
    
    <button onclick="createChart()">Create Chart</button>
    <button onclick="testAPI()">Test Coverage API</button>
    
    <div id="results"></div>
    
    <div style="width: 600px; height: 400px; margin: 20px 0;">
        <canvas id="testChart"></canvas>
    </div>

    <script>
        async function testAPI() {
            const results = document.getElementById('results');
            try {
                console.log('Testing coverage API...');
                const response = await fetch('/api/mitre/coverage');
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Coverage data:', data);
                results.innerHTML = `<pre>Coverage API data: ${JSON.stringify(data, null, 2)}</pre>`;
                return data;
            } catch (error) {
                console.error('Coverage API test failed:', error);
                results.innerHTML = `<p>Coverage API test: FAILED - ${error.message}</p>`;
                return null;
            }
        }
        
        async function createChart() {
            console.log('Creating test chart...');
            const coverageData = await testAPI();
            
            if (!coverageData) {
                console.error('No coverage data available');
                return;
            }
            
            const ctx = document.getElementById('testChart');
            if (!ctx) {
                console.error('Canvas element not found');
                return;
            }
            
            console.log('Creating Chart.js instance with data:', coverageData);
            
            try {
                const chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(coverageData),
                        datasets: [{
                            label: 'Coverage Percentage',
                            data: Object.values(coverageData),
                            backgroundColor: 'rgba(33, 150, 243, 0.8)',
                            borderColor: 'rgba(33, 150, 243, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'MITRE ATT&CK Coverage by Tactic (Test)',
                                font: {
                                    size: 16
                                }
                            },
                            legend: {
                                display: true
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Coverage %'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'MITRE ATT&CK Tactics'
                                }
                            }
                        }
                    }
                });
                console.log('Chart created successfully:', chart);
                document.getElementById('results').innerHTML += '<p style="color: green;">Chart created successfully!</p>';
            } catch (error) {
                console.error('Error creating chart:', error);
                document.getElementById('results').innerHTML += `<p style="color: red;">Chart creation failed: ${error.message}</p>`;
            }
        }
        
        // Auto-test on page load
        window.addEventListener('DOMContentLoaded', () => {
            console.log('Page loaded, running test...');
            setTimeout(testAPI, 500);
        });
    </script>
</body>
</html>