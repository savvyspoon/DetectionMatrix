<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risk Debug Test</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
    <div x-data="testData()" x-init="init()">
        <h1>Debug Risk Object ID: <span x-text="objectId"></span></h1>
        
        <h2>Loading State: <span x-text="loading ? 'Loading...' : 'Loaded'"></span></h2>
        
        <h2>Risk Object:</h2>
        <pre x-text="JSON.stringify(riskObject, null, 2)"></pre>
        
        <h2>Events Count: <span x-text="events.length"></span></h2>
        <pre x-text="JSON.stringify(events, null, 2)"></pre>
        
        <h2>Risk Score History:</h2>
        <pre x-text="JSON.stringify(calculateRiskScoreHistory(), null, 2)"></pre>
        
        <h2>Chart Canvas:</h2>
        <canvas id="riskTrendChart" width="400" height="200"></canvas>
        
        <button @click="testChart()">Test Chart Manually</button>
    </div>

    <script>
        function testData() {
            return {
                objectId: null,
                riskObject: null,
                events: [],
                loading: true,
                chart: null,
                
                async init() {
                    const urlParams = new URLSearchParams(window.location.search);
                    this.objectId = urlParams.get('id') || '5';
                    console.log('Initializing with ID:', this.objectId);
                    await this.fetchData();
                },
                
                async fetchData() {
                    this.loading = true;
                    try {
                        // Fetch risk object
                        const objResponse = await fetch(`/api/risk/objects/${this.objectId}`);
                        this.riskObject = await objResponse.json();
                        console.log('Risk Object:', this.riskObject);
                        
                        // Fetch events
                        const eventsResponse = await fetch(`/api/events/entity/${this.objectId}`);
                        this.events = await eventsResponse.json();
                        console.log('Events:', this.events);
                        
                        // Try to init chart
                        this.$nextTick(() => {
                            this.initChart();
                        });
                    } catch (error) {
                        console.error('Error fetching data:', error);
                    }
                    this.loading = false;
                },
                
                calculateRiskScoreHistory() {
                    if (!this.events || this.events.length === 0) {
                        if (this.riskObject && this.riskObject.current_score > 0) {
                            return [{
                                timestamp: new Date(this.riskObject.last_seen || new Date()),
                                score: this.riskObject.current_score,
                                change: 0,
                                event: null
                            }];
                        }
                        return [];
                    }
                    
                    const sortedEvents = [...this.events].sort((a, b) => 
                        new Date(a.timestamp) - new Date(b.timestamp)
                    );
                    
                    const history = [];
                    let currentScore = 0;
                    
                    sortedEvents.forEach(event => {
                        if (!event.is_false_positive) {
                            const previousScore = currentScore;
                            currentScore += event.risk_points || 0;
                            
                            history.push({
                                timestamp: new Date(event.timestamp),
                                score: currentScore,
                                change: currentScore - previousScore,
                                event: event
                            });
                        }
                    });
                    
                    return history;
                },
                
                initChart() {
                    console.log('Initializing chart...');
                    const canvas = document.getElementById('riskTrendChart');
                    if (!canvas) {
                        console.error('Canvas not found!');
                        return;
                    }
                    
                    const history = this.calculateRiskScoreHistory();
                    console.log('History for chart:', history);
                    
                    if (history.length === 0) {
                        console.log('No history data for chart');
                        return;
                    }
                    
                    if (this.chart) {
                        this.chart.destroy();
                    }
                    
                    const ctx = canvas.getContext('2d');
                    
                    this.chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: history.map(h => h.timestamp.toLocaleDateString()),
                            datasets: [{
                                label: 'Risk Score',
                                data: history.map(h => h.score),
                                borderColor: '#dc3545',
                                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                    console.log('Chart created:', this.chart);
                },
                
                testChart() {
                    this.initChart();
                }
            };
        }
    </script>
</body>
</html>