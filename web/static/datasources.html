<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Sources - RiskMatrix</title>
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/main.css">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="js/utils.js"></script>
    <script src="js/datasources.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">
                <h1>RiskMatrix</h1>
            </div>
            <nav>
                <ul>
                    <li><a href="index.html">Dashboard</a></li>
                    <li><a href="detections-list.html">Detections</a></li>
                    <li><a href="mitre.html">MITRE ATT&CK</a></li>
                    <li><a href="datasources.html" class="active">Data Sources</a></li>
                    <li><a href="events.html">Events</a></li>
                    <li><a href="risk-objects.html">Risk Objects</a></li>
                    <li><a href="risk-alerts.html">Risk Alerts</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="card" x-data="dataSourcesData()" x-init="init()">
            <div class="card-header compact">
                <h2>Data Sources</h2>
                <div class="card-actions">
                    <button class="btn btn-primary btn-sm" @click="showForm = true" x-show="!showForm && (!selectedDataSource || !selectedDataSource.id)">+ Add</button>
                </div>
            </div>
            
            <!-- Utilization Overview -->
            <div class="utilization-overview compact" x-show="!showForm && (!selectedDataSource || !selectedDataSource.id)">
                <h3>Utilization</h3>
                <div class="chart-container" style="height: 150px;">
                    <canvas id="utilizationChart"></canvas>
                </div>
            </div>
            
            <!-- Filters -->
            <div class="filters compact" x-show="!showForm && (!selectedDataSource || !selectedDataSource.id)">
                <div class="filter-row">
                    <div class="form-group">
                        <input type="text" id="search" x-model="searchTerm" @input="applyFilters()" placeholder="Search..." class="compact-input">
                    </div>
                </div>
            </div>
            
            <!-- Data Source List -->
            <div class="datasource-list compact" x-show="!showForm && (!selectedDataSource || !selectedDataSource.id)">
                <div class="table-container">
                    <table class="compact-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Format</th>
                            <th>Det.</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="dataSource in filteredDataSources" :key="dataSource.id">
                            <tr>
                                <td x-text="dataSource.name" class="name-cell"></td>
                                <td x-text="dataSource.description || '-'" class="desc-cell"></td>
                                <td x-text="dataSource.log_format || '-'" class="format-cell"></td>
                                <td x-text="utilization[dataSource.name] || 0" class="count-cell"></td>
                                <td class="actions-cell">
                                    <a @click="selectDataSource(dataSource.id)" class="btn-link">Edit</a>
                                    <a @click="deleteDataSource(dataSource.id)" class="btn-link delete">Del</a>
                                </td>
                            </tr>
                        </template>
                        <tr x-show="filteredDataSources.length === 0">
                            <td colspan="5" class="text-center">No data sources found</td>
                        </tr>
                    </tbody>
                    </table>
                </div>
            </div>
            
            <!-- New Data Source Form -->
            <div class="datasource-form compact" x-show="showForm">
                <h3>Add Data Source</h3>
                <form @submit.prevent="createDataSource()">
                    <div class="form-group compact">
                        <label for="name">Name</label>
                        <input type="text" id="name" x-model="newDataSource.name" required class="compact-input">
                        <small>e.g., sysmon, cloudtrail</small>
                    </div>
                    <div class="form-group compact">
                        <label for="description">Description</label>
                        <textarea id="description" x-model="newDataSource.description" rows="2" class="compact-textarea"></textarea>
                    </div>
                    <div class="form-group compact">
                        <label for="log-format">Format</label>
                        <input type="text" id="log-format" x-model="newDataSource.log_format" class="compact-input">
                        <small>e.g., JSON, XML</small>
                    </div>
                    <div class="form-actions compact">
                        <button type="submit" class="btn btn-success btn-sm">Save</button>
                        <button type="button" class="btn btn-sm" @click="showForm = false">Cancel</button>
                    </div>
                </form>
            </div>
            
            <!-- Data Source Details -->
            <div class="datasource-details compact" x-show="selectedDataSource && selectedDataSource.id">
                <h3>Edit Data Source</h3>
                <form @submit.prevent="updateDataSource()">
                    <div class="form-group compact">
                        <label for="edit-name">Name</label>
                        <input type="text" id="edit-name" x-model="selectedDataSource?.name" :value="selectedDataSource?.name || ''" required class="compact-input">
                    </div>
                    <div class="form-group compact">
                        <label for="edit-description">Description</label>
                        <textarea id="edit-description" x-model="selectedDataSource?.description" :value="selectedDataSource?.description || ''" rows="2" class="compact-textarea"></textarea>
                    </div>
                    <div class="form-group compact">
                        <label for="edit-log-format">Format</label>
                        <input type="text" id="edit-log-format" x-model="selectedDataSource?.log_format" :value="selectedDataSource?.log_format || ''" class="compact-input">
                    </div>
                    
                    <!-- Associated Detections -->
                    <div class="related-data compact">
                        <h4>Detections</h4>
                        <div x-show="associatedDetections.length === 0" class="empty-state compact">
                            No associated detections
                        </div>
                        <div class="table-container" x-show="associatedDetections.length > 0">
                            <table class="compact-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Status</th>
                                    <th>Sev</th>
                                    <th>Pts</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="detection in associatedDetections" :key="detection.id">
                                    <tr>
                                        <td x-text="detection.name" class="name-cell"></td>
                                        <td>
                                            <span x-text="detection.status" :class="`badge compact status-${detection.status}`"></span>
                                        </td>
                                        <td>
                                            <span x-text="detection.severity.substr(0,3).toUpperCase()" :class="`badge compact severity-${detection.severity}`"></span>
                                        </td>
                                        <td x-text="detection.risk_points" class="count-cell"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Associated MITRE Techniques -->
                    <div class="related-data compact">
                        <h4>MITRE Techniques</h4>
                        <div x-show="associatedTechniques.length === 0" class="empty-state compact">
                            No associated techniques
                        </div>
                        <div class="table-container" x-show="associatedTechniques.length > 0">
                            <table class="compact-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Tactic</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="technique in associatedTechniques" :key="technique.id">
                                    <tr>
                                        <td>
                                            <span class="technique-id compact" x-text="technique.id"></span>
                                        </td>
                                        <td x-text="technique.name" class="name-cell"></td>
                                        <td>
                                            <span class="badge compact badge-primary" x-text="technique.tactic.substr(0,10)"></span>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="form-actions compact">
                        <button type="submit" class="btn btn-success btn-sm">Update</button>
                        <button type="button" class="btn btn-sm" @click="closeModal()">Back</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 RiskMatrix - Detection Management Platform</p>
        </div>
    </footer>

    <style>
        /* Compact header */
        .card-header.compact {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .card-header.compact h2 {
            font-size: 1.3rem;
            margin: 0;
        }
        
        .btn-sm {
            padding: 0.3rem 0.6rem;
            font-size: 0.85rem;
        }
        
        /* Compact chart */
        .utilization-overview.compact {
            margin-bottom: 0.75rem;
        }
        
        .utilization-overview.compact h3 {
            font-size: 1rem;
            margin: 0 0 0.5rem 0;
        }
        
        /* Compact filters */
        .filters.compact {
            margin-bottom: 0.75rem;
        }
        
        .filter-row {
            display: flex;
            gap: 0.5rem;
        }
        
        .filter-row .form-group {
            flex: 1;
        }
        
        .compact-input,
        .compact-select,
        .compact-textarea {
            padding: 0.3rem 0.5rem;
            font-size: 0.85rem;
            border: 1px solid #ddd;
            border-radius: 3px;
            width: 100%;
        }
        
        .compact-textarea {
            resize: vertical;
        }
        
        /* Compact table */
        .datasource-list.compact {
            margin-top: 0.5rem;
        }
        
        .compact-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        
        .compact-table th {
            background-color: #f8f9fa;
            padding: 0.4rem 0.5rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.8rem;
            border-bottom: 1px solid #dee2e6;
        }
        
        .compact-table td {
            padding: 0.35rem 0.5rem;
            border-bottom: 1px solid #eee;
        }
        
        .compact-table tr:hover {
            background-color: #f8f9fa;
        }
        
        /* Cell styles */
        .name-cell {
            font-weight: 500;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .desc-cell {
            max-width: 250px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #666;
            font-size: 0.8rem;
        }
        
        .format-cell {
            font-size: 0.8rem;
            color: #666;
        }
        
        .count-cell {
            text-align: center;
            font-weight: 500;
        }
        
        .actions-cell {
            white-space: nowrap;
        }
        
        /* Compact forms */
        .datasource-form.compact h3,
        .datasource-details.compact h3 {
            font-size: 1.1rem;
            margin: 0 0 0.75rem 0;
        }
        
        .form-group.compact {
            margin-bottom: 0.5rem;
        }
        
        .form-group.compact label {
            display: block;
            margin-bottom: 0.2rem;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .form-group.compact small {
            display: block;
            margin-top: 0.15rem;
            color: #666;
            font-size: 0.7rem;
        }
        
        .form-actions.compact {
            display: flex;
            gap: 0.4rem;
            margin-top: 0.75rem;
        }
        
        /* Related data sections */
        .related-data.compact {
            margin-top: 0.75rem;
        }
        
        .related-data.compact h4 {
            margin-bottom: 0.3rem;
            color: var(--primary-color);
            font-size: 0.95rem;
        }
        
        .empty-state.compact {
            padding: 0.5rem;
            color: #999;
            font-style: italic;
            font-size: 0.8rem;
        }
        
        /* Compact badges */
        .badge.compact {
            display: inline-block;
            padding: 0.15rem 0.3rem;
            border-radius: 3px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .technique-id.compact {
            font-family: monospace;
            font-size: 0.75rem;
            color: var(--primary-color);
        }
        
        /* Status colors */
        .status-idea { background-color: #e3f2fd; color: #0d47a1; }
        .status-draft { background-color: #e8f5e9; color: #1b5e20; }
        .status-test { background-color: #fff3e0; color: #e65100; }
        .status-production { background-color: #e8eaf6; color: #303f9f; }
        .status-retired { background-color: #fafafa; color: #616161; }
        
        /* Severity colors */
        .severity-low { background-color: #e8f5e9; color: #2e7d32; }
        .severity-medium { background-color: #fff3e0; color: #f57c00; }
        .severity-high { background-color: #fbe9e7; color: #d84315; }
        .severity-critical { background-color: #ffebee; color: #c62828; }
        
        /* Link buttons */
        .btn-link {
            color: var(--primary-color);
            text-decoration: none;
            font-size: 0.8rem;
            padding: 0.2rem 0.4rem;
            margin-right: 0.3rem;
            cursor: pointer;
        }
        
        .btn-link:hover {
            text-decoration: underline;
        }
        
        .btn-link.delete {
            color: #dc3545;
        }
        
        .text-center {
            text-align: center;
            color: #999;
            font-style: italic;
        }
    </style>
</body>
</html>